apiVersion: apps/v1
kind: Deployment
metadata:
  name: federation-tester
  namespace: app-matrix
  labels:
    app: federation-tester
spec:
  replicas: 1
  revisionHistoryLimit: 2
  selector:
    matchLabels:
      app: federation-tester
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: federation-tester
    spec:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      # Wait for database to be ready before starting
      initContainers:
        - name: wait-for-db
          image: postgres:16-alpine
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              until pg_isready -h federation-tester-db-rw.app-matrix.svc -p 5432 -U "$FEDTEST_DB_USER"; do
                echo "Waiting for Federation Tester database..."
                sleep 2
              done
              echo "Database is ready"
          env:
            - name: FEDTEST_DB_USER
              valueFrom:
                secretKeyRef:
                  name: federation-tester-db-app
                  key: username
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
        # WORKAROUND: Upstream bug in rust-federation-tester migrations
        # Migration m20250710 creates idx_email_server_name_unique and alert_email_key constraint,
        # but m20250922 tries to create a composite constraint that conflicts with these.
        # This init container drops the conflicting objects so m20250922 can create the correct
        # composite constraint. Safe to run on first deploy (IF EXISTS handles missing objects).
        # Track upstream: https://github.com/MTRNord/rust-federation-tester
        - name: fix-migrations
          image: postgres:16-alpine
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              until pg_isready -h federation-tester-db-rw.app-matrix.svc -p 5432 -U "$FEDTEST_DB_USER"; do
                echo "Waiting for database to be ready..."
                sleep 2
              done
              echo "Database is ready, fixing migration conflicts..."
              PGPASSWORD="$FEDTEST_DB_PASSWORD" psql -h federation-tester-db-rw.app-matrix.svc -p 5432 -U "$FEDTEST_DB_USER" -d "$FEDTEST_DB_NAME" <<'EOF'
              -- Drop the conflicting index created by m20250710 migration
              DROP INDEX IF EXISTS idx_email_server_name_unique;

              -- Drop the old email uniqueness constraint (name may vary)
              -- This allows m20250922 migration to create the correct composite constraint
              ALTER TABLE IF EXISTS alert DROP CONSTRAINT IF EXISTS alert_email_key;
              EOF
              echo "Migration fix complete"
          env:
            - name: FEDTEST_DB_USER
              valueFrom:
                secretKeyRef:
                  name: federation-tester-db-app
                  key: username
            - name: FEDTEST_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: federation-tester-db-app
                  key: password
            - name: FEDTEST_DB_NAME
              valueFrom:
                secretKeyRef:
                  name: federation-tester-db-app
                  key: dbname
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
        - name: config-templating
          image: oaudry/envsubst:1.6
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              echo "Processing config template with envsubst..."
              envsubst < /config-template/config.yaml > /config-processed/config.yaml
              echo "Config templating complete"
              cat /config-processed/config.yaml
          envFrom:
            - configMapRef:
                name: federation-tester-env
          env:
            - name: FEDTEST_DB_USER
              valueFrom:
                secretKeyRef:
                  name: federation-tester-db-app
                  key: username
            - name: FEDTEST_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: federation-tester-db-app
                  key: password
            - name: FEDTEST_DB_NAME
              valueFrom:
                secretKeyRef:
                  name: federation-tester-db-app
                  key: dbname
            - name: FEDTEST_STATS_SALT
              valueFrom:
                secretKeyRef:
                  name: federation-tester-secrets
                  key: FEDTEST_STATS_SALT
          volumeMounts:
            - name: config-template
              mountPath: /config-template
              readOnly: true
            - name: config-processed
              mountPath: /config-processed
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
      containers:
        - name: federation-tester
          image: ghcr.io/mtrnord/rust-federation-tester:0.3.4
          imagePullPolicy: IfNotPresent
          workingDir: /app
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: federation-tester-db-app
                  key: uri
            - name: RUST_LOG
              valueFrom:
                configMapKeyRef:
                  name: federation-tester-env
                  key: RUST_LOG
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          securityContext:
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          volumeMounts:
            - name: config-processed
              mountPath: /app
      volumes:
        - name: config-template
          configMap:
            name: federation-tester-config
        - name: config-processed
          emptyDir: {}
