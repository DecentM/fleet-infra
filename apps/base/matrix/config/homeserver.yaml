# Server identification
server_name: "testing.borooka.ee"
public_baseurl: "https://matrix-testing.borooka.ee/"
pid_file: /data/homeserver.pid

# Database configuration - uses CNPG secret for credentials
# The actual connection details are injected via environment variables
database:
  name: psycopg2
  args:
    user: synapse
    password: "${SYNAPSE_DATABASE_PASSWORD}"
    database: synapse
    host: matrix-db-rw.app-matrix.svc
    port: 5432
    cp_min: 5
    cp_max: 10

# HTTP listener configuration
listeners:
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    bind_addresses: ['0.0.0.0']
    resources:
      - names: [client, federation, metrics]
        compress: false

# Media storage configuration
media_store_path: /data/media_store
max_upload_size: 25M
max_image_pixels: 32M
url_preview_enabled: true
url_preview_ip_range_blacklist:
  - '127.0.0.0/8'
  - '10.0.0.0/8'
  - '172.16.0.0/12'
  - '192.168.0.0/16'
  - '100.64.0.0/10'
  - '169.254.0.0/16'
  - 'fe80::/64'

# Signing key - must be generated before first run
signing_key_path: /data/testing.borooka.ee.signing.key

# Registration settings
enable_registration: false
registration_shared_secret: "${SYNAPSE_REGISTRATION_SHARED_SECRET}"

# Security secrets
macaroon_secret_key: "${SYNAPSE_MACAROON_SECRET_KEY}"
form_secret: "${SYNAPSE_FORM_SECRET}"

# Trusted key servers for federation
trusted_key_servers:
  - server_name: "matrix.org"

# Enable metrics for Prometheus scraping
enable_metrics: true

# Report anonymous statistics to help improve Synapse
report_stats: false

# TURN server configuration for VoIP
turn_uris:
  - "turn:eu.relay.metered.ca:80"
  - "turn:eu.relay.metered.ca:80?transport=tcp"
  - "turns:eu.relay.metered.ca:443?transport=tcp"
turn_username: "${SYNAPSE_TURN_USERNAME}"
turn_password: "${SYNAPSE_TURN_PASSWORD}"
turn_allow_guests: true

# Logging configuration
log_config: "/config/log.config"

# Application services (bridges)
app_service_config_files:
  - /data/hookshot-registration.yml
  - /config/call-janitor-registration.yaml

# Experimental features for E2E encryption bridge support (MSC2409, MSC3202)
# Required for Hookshot to work in encrypted rooms
experimental_features:
  msc3202_device_masquerading: true
  msc3202_transaction_extensions: true
  msc2409_to_device_messages_enabled: true
  # MatrixRTC / Element Call support (MSC4140, MSC3266)
  msc4140_enabled: true  # Delayed events for proper call signalling
  msc3266_enabled: true  # Room summaries

# Auto-join rooms for new users (Discord-like onboarding)
auto_join_rooms:
  - "#welcome:testing.borooka.ee"
  - "#general:testing.borooka.ee"
  - "#announcements:testing.borooka.ee"
autocreate_auto_join_rooms: true
autocreate_auto_join_rooms_federated: true
autocreate_auto_join_room_preset: public_chat
auto_join_mxid_localpart: system

# Server notices for admin announcements
server_notices:
  system_mxid_localpart: notices
  system_mxid_display_name: "System Announcements"
  room_name: "Announcements"
  room_topic: "Updates from the admins"
  auto_join: true

# Encryption settings
encryption_enabled_by_default_for_room_type: invite

# Default power levels for public_chat preset (moderation controls)
default_power_level_content_override:
  public_chat:
    invite: 50
    redact: 50
    kick: 50
    ban: 50
