# Synapse Matrix Homeserver
# Documentation: https://matrix-org.github.io/synapse/latest/
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: synapse
  namespace: app-matrix
  labels:
    app: synapse
    app.kubernetes.io/name: synapse
    app.kubernetes.io/component: homeserver
    app.kubernetes.io/part-of: matrix
spec:
  replicas: 1
  revisionHistoryLimit: 2
  selector:
    matchLabels:
      app: synapse
  strategy:
    type: Recreate  # Single replica with PVC requires Recreate
  template:
    metadata:
      labels:
        app: synapse
        app.kubernetes.io/name: synapse
    spec:
      securityContext:
        runAsUser: 991
        runAsGroup: 991
        fsGroup: 991
      # Wait for database to be ready
      initContainers:
        - name: wait-for-db
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              until nc -z matrix-db-rw.app-matrix.svc 5432; do
                echo "Waiting for database..."
                sleep 2
              done
              echo "Database is ready"
          securityContext:
            runAsUser: 991
            runAsGroup: 991
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
        # Run badlist database migration (idempotent - safe to run every start)
        # Creates the badlist schema and tables if they don't exist
        - name: badlist-migration
          image: postgres:16.12-alpine
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              echo "Running badlist migration..."
              PGPASSWORD="${DB_PASSWORD}" psql \
                -h matrix-db-rw.app-matrix.svc \
                -p 5432 \
                -U "${DB_USER}" \
                -d "${DB_NAME}" \
                -f /migration/badlist-migration.sql
              echo "Badlist migration completed"
          env:
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: matrix-db-app
                  key: dbname
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: matrix-db-app
                  key: user
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: matrix-db-app
                  key: password
          volumeMounts:
            - name: badlist-migration-sql
              mountPath: /migration
              readOnly: true
          securityContext:
            runAsUser: 991
            runAsGroup: 991
            allowPrivilegeEscalation: false
        # Process config templates with environment variable substitution
        - name: config-templating
          image: oaudry/envsubst:1.6
          command:
            - sh
            - -c
            - |
              echo "Processing config templates with envsubst..."
              for file in /config-template/*; do
                filename=$(basename "$file")
                echo "Processing $filename..."
                envsubst < "$file" > "/config-processed/$filename"
              done
              # Process hookshot registration template separately
              for file in /hookshot-template/*; do
                filename=$(basename "$file")
                echo "Processing hookshot template: $filename..."
                envsubst < "$file" > "/config-processed/$filename"
              done
              # Process meowlnir registration template
              for file in /meowlnir-template/*; do
                filename=$(basename "$file")
                echo "Processing meowlnir template: $filename..."
                envsubst < "$file" > "/config-processed/$filename"
              done
              echo "Config templating complete"
              ls -la /config-processed/
          env:
            - name: SYNAPSE_DATABASE_DBNAME
              valueFrom:
                secretKeyRef:
                  name: matrix-db-app
                  key: dbname
            - name: SYNAPSE_DATABASE_USER
              valueFrom:
                secretKeyRef:
                  name: matrix-db-app
                  key: user
            - name: SYNAPSE_DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: matrix-db-app
                  key: password
            - name: SYNAPSE_REGISTRATION_SHARED_SECRET
              valueFrom:
                secretKeyRef:
                  name: synapse-secrets
                  key: registration-shared-secret
            - name: SYNAPSE_MACAROON_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: synapse-secrets
                  key: macaroon-secret-key
            - name: SYNAPSE_FORM_SECRET
              valueFrom:
                secretKeyRef:
                  name: synapse-secrets
                  key: form-secret
            - name: SYNAPSE_TURN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: turn-secrets
                  key: turn-username
            - name: SYNAPSE_TURN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: turn-secrets
                  key: turn-password
            - name: HOOKSHOT_AS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: hookshot-secrets
                  key: as-token
            - name: HOOKSHOT_HS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: hookshot-secrets
                  key: hs-token
            # Meowlnir tokens (for registration template and antispam)
            - name: MEOWLNIR_AS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: meowlnir-secrets
                  key: meowlnir_as_token
            - name: MEOWLNIR_HS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: meowlnir-secrets
                  key: meowlnir_hs_token
            - name: MEOWLNIR_ANTISPAM_TOKEN
              valueFrom:
                secretKeyRef:
                  name: meowlnir-secrets
                  key: meowlnir_as_token
            # Public base URL for badlist module
            - name: SYNAPSE_PUBLIC_BASEURL
              value: "https://matrix-testing.borooka.ee/"
          volumeMounts:
            - name: config-template
              mountPath: /config-template
              readOnly: true
            - name: config-processed
              mountPath: /config-processed
            - name: hookshot-registration-template
              mountPath: /hookshot-template
              readOnly: true
            - name: meowlnir-registration-template
              mountPath: /meowlnir-template
              readOnly: true
          securityContext:
            runAsUser: 991
            runAsGroup: 991
            allowPrivilegeEscalation: false
      containers:
        - name: synapse
          image: ghcr.io/decentm/synapse-antispam:latest
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: "2"
              memory: 2Gi
          securityContext:
            runAsUser: 991
            runAsGroup: 991
            allowPrivilegeEscalation: false
          env:
            - name: SYNAPSE_CONFIG_PATH
              value: /config/homeserver.yaml
            - name: SYNAPSE_DATABASE_DBNAME
              valueFrom:
                secretKeyRef:
                  name: matrix-db-app
                  key: dbname
            - name: SYNAPSE_DATABASE_USER
              valueFrom:
                secretKeyRef:
                  name: matrix-db-app
                  key: user
            # Database password from CNPG-generated secret
            - name: SYNAPSE_DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: matrix-db-app
                  key: password
            - name: SYNAPSE_REGISTRATION_SHARED_SECRET
              valueFrom:
                secretKeyRef:
                  name: synapse-secrets
                  key: registration-shared-secret
            - name: SYNAPSE_MACAROON_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: synapse-secrets
                  key: macaroon-secret-key
            - name: SYNAPSE_FORM_SECRET
              valueFrom:
                secretKeyRef:
                  name: synapse-secrets
                  key: form-secret
            - name: SYNAPSE_TURN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: turn-secrets
                  key: turn-username
            - name: SYNAPSE_TURN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: turn-secrets
                  key: turn-password
          ports:
            - name: http
              containerPort: 8008
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          volumeMounts:
            - name: config-processed
              mountPath: /config
              readOnly: true
            - name: data
              mountPath: /data
            - name: signing-key
              mountPath: /data/testing.borooka.ee.signing.key
              subPath: testing.borooka.ee.signing.key
              readOnly: true
            - name: config-processed
              mountPath: /data/hookshot-registration.yml
              subPath: hookshot-registration.yml
              readOnly: true
            - name: config-processed
              mountPath: /data/meowlnir-registration.yml
              subPath: meowlnir-registration.yml
              readOnly: true
      volumes:
        - name: config-template
          configMap:
            name: synapse-config
        - name: config-processed
          emptyDir: {}
        - name: data
          persistentVolumeClaim:
            claimName: synapse-media
        # Generate using: docker run --rm -v /tmp:/data matrixdotorg/synapse:v1.147.1 generate
        - name: signing-key
          secret:
            secretName: synapse-signing-key
            items:
              - key: signing.key
                path: testing.borooka.ee.signing.key
        - name: hookshot-registration-template
          configMap:
            name: hookshot-config
            items:
              - key: hookshot-registration.yml
                path: hookshot-registration.yml
        - name: meowlnir-registration-template
          configMap:
            name: meowlnir-config
            items:
              - key: meowlnir-registration.yml
                path: meowlnir-registration.yml
        - name: badlist-migration-sql
          configMap:
            name: synapse-badlist-migration
---
apiVersion: v1
kind: Service
metadata:
  name: synapse
  namespace: app-matrix
  labels:
    app: synapse
    app.kubernetes.io/name: synapse
    app.kubernetes.io/component: homeserver
    app.kubernetes.io/part-of: matrix
    job: synapse
  # Prometheus annotations for service discovery
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8008"
    prometheus.io/path: "/_synapse/metrics"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8008
      targetPort: http
      protocol: TCP
  selector:
    app: synapse
