# Event Persister Worker Deployment
# Handles writing events to the database
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: synapse-event-persister
  namespace: app-matrix
  labels:
    app: synapse-event-persister
    app.kubernetes.io/name: synapse
    app.kubernetes.io/component: event-persister
    app.kubernetes.io/part-of: matrix
spec:
  replicas: 1
  revisionHistoryLimit: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      app: synapse-event-persister
  template:
    metadata:
      labels:
        app: synapse-event-persister
        app.kubernetes.io/name: synapse
        app.kubernetes.io/component: event-persister
    spec:
      nodeSelector:
        kubernetes.io/hostname: cadance
      securityContext:
        runAsUser: 991
        runAsGroup: 991
        fsGroup: 991
      # Wait for Redis to be ready
      initContainers:
        - name: wait-for-redis
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              until nc -z synapse-redis.app-matrix.svc 6379; do
                echo "Waiting for Redis..."
                sleep 2
              done
              echo "Redis is ready"
          securityContext:
            runAsUser: 991
            runAsGroup: 991
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
        # Process config templates with environment variable substitution
        - name: config-templating
          image: oaudry/envsubst:1.6
          command:
            - sh
            - -c
            - |
              #!/bin/sh
              set -e

              echo "Processing homeserver.yaml..."
              envsubst < /config-template/homeserver.yaml > /config-processed/homeserver.yaml

              echo "Processing log.config..."
              envsubst < /config-template/log.config > /config-processed/log.config

              # Process worker-specific config
              for file in /worker-config-template/*; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  echo "Processing worker config: $filename..."
                  envsubst < "$file" > "/config-processed/$filename"
                fi
              done

              # Process appservice registration templates
              # These are needed for appservice notification handling
              for file in /hookshot-template/*; do
                filename=$(basename "$file")
                echo "Processing hookshot template: $filename..."
                envsubst < "$file" > "/config-processed/$filename"
              done
              for file in /meowlnir-template/*; do
                filename=$(basename "$file")
                echo "Processing meowlnir template: $filename..."
                envsubst < "$file" > "/config-processed/$filename"
              done
              for file in /discord-template/*; do
                filename=$(basename "$file")
                echo "Processing discord template: $filename..."
                envsubst < "$file" > "/config-processed/$filename"
              done
              for file in /signal-template/*; do
                filename=$(basename "$file")
                echo "Processing signal template: $filename..."
                envsubst < "$file" > "/config-processed/$filename"
              done
              for file in /meetings-template/*; do
                filename=$(basename "$file")
                echo "Processing meetings template: $filename..."
                envsubst < "$file" > "/config-processed/$filename"
              done

              echo "Config templating complete"
              ls -lh /config-processed/
          env:
            - name: SYNAPSE_WORKER_NAME
              value: "event_persister1"
            - name: SYNAPSE_DATABASE_DBNAME
              valueFrom:
                secretKeyRef:
                  name: matrix-db-app
                  key: dbname
            - name: SYNAPSE_DATABASE_USER
              valueFrom:
                secretKeyRef:
                  name: matrix-db-app
                  key: user
            - name: SYNAPSE_DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: matrix-db-app
                  key: password
            - name: SYNAPSE_REGISTRATION_SHARED_SECRET
              valueFrom:
                secretKeyRef:
                  name: synapse-secrets
                  key: registration-shared-secret
            - name: SYNAPSE_MACAROON_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: synapse-secrets
                  key: macaroon-secret-key
            - name: SYNAPSE_FORM_SECRET
              valueFrom:
                secretKeyRef:
                  name: synapse-secrets
                  key: form-secret
            - name: SYNAPSE_TURN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: turn-secrets
                  key: turn-username
            - name: SYNAPSE_TURN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: turn-secrets
                  key: turn-password
            - name: SYNAPSE_WORKER_REPLICATION_SECRET
              valueFrom:
                secretKeyRef:
                  name: synapse-secrets
                  key: worker-replication-secret
            - name: OIDC_CLIENT_MATRIX_SECRET
              valueFrom:
                secretKeyRef:
                  name: synapse-secrets
                  key: OIDC_CLIENT_MATRIX_SECRET
            - name: MEOWLNIR_ANTISPAM_TOKEN
              valueFrom:
                secretKeyRef:
                  name: meowlnir-secrets
                  key: meowlnir_as_token
            # Appservice tokens for registration templates
            - name: HOOKSHOT_AS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: hookshot-secrets
                  key: as-token
            - name: HOOKSHOT_HS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: hookshot-secrets
                  key: hs-token
            - name: MEOWLNIR_AS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: meowlnir-secrets
                  key: meowlnir_as_token
            - name: MEOWLNIR_HS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: meowlnir-secrets
                  key: meowlnir_hs_token
            - name: DISCORD_AS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: mautrix-discord-secrets
                  key: as-token
            - name: DISCORD_HS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: mautrix-discord-secrets
                  key: hs-token
            - name: SIGNAL_AS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: mautrix-signal-secrets
                  key: as-token
            - name: SIGNAL_HS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: mautrix-signal-secrets
                  key: hs-token
            - name: MEETINGS_BOT_AS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: matrix-meetings-secrets
                  key: as-token
            - name: MEETINGS_BOT_HS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: matrix-meetings-secrets
                  key: hs-token
            # S3/B2 storage credentials
            - name: SYNAPSE_S3_BUCKET
              valueFrom:
                secretKeyRef:
                  name: synapse-s3-secrets
                  key: bucket-name
            - name: SYNAPSE_S3_ENDPOINT_URL
              valueFrom:
                secretKeyRef:
                  name: synapse-s3-secrets
                  key: endpoint-url
            - name: SYNAPSE_S3_REGION
              valueFrom:
                secretKeyRef:
                  name: synapse-s3-secrets
                  key: region
            - name: SYNAPSE_S3_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: synapse-s3-secrets
                  key: access-key-id
            - name: SYNAPSE_S3_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: synapse-s3-secrets
                  key: secret-access-key
          volumeMounts:
            - name: config-template
              mountPath: /config-template
              readOnly: true
            - name: worker-config-template
              mountPath: /worker-config-template
              readOnly: true
            - name: config-processed
              mountPath: /config-processed
            # Appservice registration templates
            - name: hookshot-registration-template
              mountPath: /hookshot-template
              readOnly: true
            - name: meowlnir-registration-template
              mountPath: /meowlnir-template
              readOnly: true
            - name: discord-registration-template
              mountPath: /discord-template
              readOnly: true
            - name: signal-registration-template
              mountPath: /signal-template
              readOnly: true
            - name: meetings-registration-template
              mountPath: /meetings-template
              readOnly: true
          securityContext:
            runAsUser: 991
            runAsGroup: 991
            allowPrivilegeEscalation: false
      containers:
        - name: synapse-worker
          image: ghcr.io/decentm/synapse:sha-defa7cb
          imagePullPolicy: IfNotPresent
          args:
            - run
            - --config-path=/config/homeserver.yaml
            - --config-path=/config/worker.yaml
          resources:
            requests:
              cpu: 400m
              memory: 1Gi
            limits:
              cpu: 1500m
              memory: 2Gi
          securityContext:
            runAsUser: 991
            runAsGroup: 991
            allowPrivilegeEscalation: false
          env:
            - name: SYNAPSE_WORKER_NAME
              value: "event_persister1"
            - name: SYNAPSE_WORKER
              value: "synapse.app.generic_worker"
          ports:
            - name: http
              containerPort: 8083
              protocol: TCP
            - name: replication
              containerPort: 9093
              protocol: TCP
          # Event persister has replication listener, use tcpSocket probe
          livenessProbe:
            tcpSocket:
              port: replication
            initialDelaySeconds: 60
            periodSeconds: 30
          readinessProbe:
            tcpSocket:
              port: replication
            initialDelaySeconds: 10
            periodSeconds: 10
          volumeMounts:
            - name: config-processed
              mountPath: /config
              readOnly: true
            - name: data
              mountPath: /data
            - name: signing-key
              mountPath: /data/borooka.ee.signing.key
              subPath: borooka.ee.signing.key
              readOnly: true
      volumes:
        - name: config-template
          configMap:
            name: synapse-config
        - name: worker-config-template
          configMap:
            name: synapse-event-persister-config
        - name: config-processed
          emptyDir: {}
        # Local media cache - temporary storage only, media persisted to B2
        - name: data
          emptyDir:
            sizeLimit: 1Gi
        - name: signing-key
          secret:
            secretName: synapse-signing-key
            items:
              - key: signing.key
                path: borooka.ee.signing.key
        # Appservice registration templates
        - name: hookshot-registration-template
          configMap:
            name: hookshot-config
            items:
              - key: hookshot-registration.yml
                path: hookshot-registration.yml
        - name: meowlnir-registration-template
          configMap:
            name: meowlnir-config
            items:
              - key: meowlnir-registration.yml
                path: meowlnir-registration.yml
        - name: discord-registration-template
          configMap:
            name: mautrix-discord-config
            items:
              - key: discord-registration.yaml
                path: discord-registration.yaml
        - name: signal-registration-template
          configMap:
            name: mautrix-signal-config
            items:
              - key: signal-registration.yaml
                path: signal-registration.yaml
        - name: meetings-registration-template
          configMap:
            name: matrix-meetings-config
            items:
              - key: meetings-registration.yaml
                path: meetings-registration.yaml
---
# ClusterIP Service for replication
apiVersion: v1
kind: Service
metadata:
  name: synapse-event-persister
  namespace: app-matrix
  labels:
    app: synapse-event-persister
    app.kubernetes.io/name: synapse
    app.kubernetes.io/component: event-persister
    app.kubernetes.io/part-of: matrix
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8083
      targetPort: http
      protocol: TCP
    - name: replication
      port: 9093
      targetPort: replication
      protocol: TCP
  selector:
    app: synapse-event-persister
