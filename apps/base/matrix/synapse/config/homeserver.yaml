# Server identification
server_name: "borooka.ee"
public_baseurl: "https://matrix.borooka.ee/"
pid_file: /data/homeserver.pid

# Database configuration - uses CNPG secret for credentials
# The actual connection details are injected via environment variables
database:
  name: psycopg2
  args:
    user: synapse
    password: "${SYNAPSE_DATABASE_PASSWORD}"
    database: synapse
    host: matrix-db-rw.app-matrix.svc
    port: 5432
    cp_min: 5
    cp_max: 10

# HTTP listener configuration
listeners:
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    bind_addresses: ['0.0.0.0']
    resources:
      - names: [client, federation, metrics]
        compress: false

# Media storage configuration
media_store_path: /data/media_store
max_upload_size: 25M
max_image_pixels: 32M
url_preview_enabled: true
url_preview_ip_range_blacklist:
  - '127.0.0.0/8'
  - '10.0.0.0/8'
  - '172.16.0.0/12'
  - '192.168.0.0/16'
  - '100.64.0.0/10'
  - '169.254.0.0/16'
  - 'fe80::/64'

# Signing key - must be generated before first run
signing_key_path: /data/borooka.ee.signing.key

# Registration settings
enable_registration: false
registration_shared_secret: "${SYNAPSE_REGISTRATION_SHARED_SECRET}"

# Password authentication disabled - SSO only
password_config:
  enabled: false

# OIDC authentication via Authelia
oidc_providers:
  - idp_id: authelia
    idp_name: "Authelia SSO"
    issuer: "https://auth.borooka.ee"
    client_id: "matrix"
    client_secret: "${OIDC_CLIENT_MATRIX_SECRET}"
    scopes:
      - openid
      - profile
      - email
    user_mapping_provider:
      config:
        localpart_template: "{{ user.preferred_username }}"
        display_name_template: "{{ user.name }}"
        email_template: "{{ user.email }}"

# Security secrets
macaroon_secret_key: "${SYNAPSE_MACAROON_SECRET_KEY}"
form_secret: "${SYNAPSE_FORM_SECRET}"

# Trusted key servers for federation
trusted_key_servers:
  - server_name: "matrix.org"

# Enable metrics for Prometheus scraping
enable_metrics: true

# Report anonymous statistics to help improve Synapse
report_stats: false

# TURN server configuration for VoIP
turn_uris:
  - "turn:eu.relay.metered.ca:80"
  - "turn:eu.relay.metered.ca:80?transport=tcp"
  - "turns:eu.relay.metered.ca:443?transport=tcp"
turn_username: "${SYNAPSE_TURN_USERNAME}"
turn_password: "${SYNAPSE_TURN_PASSWORD}"
turn_allow_guests: true

# Logging configuration
log_config: "/config/log.config"

# Application services (bridges)
app_service_config_files:
  - /data/hookshot-registration.yml
  - /data/meowlnir-registration.yml
  - /data/discord-registration.yaml
  - /data/signal-registration.yaml
  - /data/meetings-registration.yaml

# Anti-spam modules configuration
modules:
  - module: synapse_http_antispam.HTTPAntispam
    config:
      base_url: http://meowlnir.app-matrix.svc:29339/_meowlnir/antispam/!meowlnir_management:borooka.ee
      authorization: ${MEOWLNIR_ANTISPAM_TOKEN}
      enabled_callbacks:
        - user_may_invite
        - user_may_join_room
      fail_open:
        user_may_invite: true
        user_may_join_room: true

# Experimental features for E2E encryption bridge support (MSC2409, MSC3202)
# Required for Hookshot to work in encrypted rooms
experimental_features:
  msc3202_device_masquerading: true
  msc3202_transaction_extensions: true
  msc2409_to_device_messages_enabled: true
  # MatrixRTC / Element Call support (MSC4140, MSC3266)
  msc4140_enabled: true  # Delayed events for proper call signalling
  msc3266_enabled: true  # Room summaries

# Auto-join rooms for new users (Discord-like onboarding)
auto_join_rooms:
  - "#welcome:borooka.ee"
  - "#general:borooka.ee"
  - "#announcements:borooka.ee"
autocreate_auto_join_rooms: true
autocreate_auto_join_rooms_federated: true
autocreate_auto_join_room_preset: public_chat
auto_join_mxid_localpart: system

# Server notices for admin announcements
server_notices:
  system_mxid_localpart: notices
  system_mxid_display_name: "System Announcements"
  room_name: "Announcements"
  room_topic: "Updates from the admins"
  auto_join: true

# Default power levels for public_chat preset (moderation controls)
default_power_level_content_override:
  public_chat:
    invite: 50
    redact: 50
    kick: 50
    ban: 50

# User directory configuration
# Required for matrix-meetings bot to find users
user_directory:
  search_all_users: true

# Room prejoin state events
# Required for matrix-meetings widget to work properly
room_prejoin_state:
  additional_event_types:
    - m.space.parent
    - net.nordeck.meetings.metadata
    - m.room.power_levels
