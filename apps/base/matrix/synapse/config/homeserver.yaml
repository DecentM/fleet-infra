server_name: "borooka.ee"
public_baseurl: "https://matrix.borooka.ee/"
worker_name: "${SYNAPSE_WORKER_NAME}"
pid_file: /data/homeserver.pid

presence:
  enabled: true

enable_authenticated_media: false

worker_replication_secret: "${SYNAPSE_WORKER_REPLICATION_SECRET}"
run_background_tasks_on: background_tasks1

redis:
  enabled: true
  host: synapse-redis.app-matrix.svc
  port: 6379

instance_map:
  main:
    host: synapse-main-repl.app-matrix.svc
    port: 9093
  federation_sender1:
    host: synapse-federation-sender.app-matrix.svc
    port: 9093
  federation_reader1:
    host: synapse-federation-reader.app-matrix.svc
    port: 9093
  event_persister1:
    host: synapse-event-persister.app-matrix.svc
    port: 9093
  client_reader1:
    host: synapse-client-reader.app-matrix.svc
    port: 9093
  background_tasks1:
    host: synapse-background-tasks.app-matrix.svc
    port: 9093
  appservice_sender1:
    host: synapse-appservice-sender.app-matrix.svc
    port: 9093

stream_writers:
  events:
    - event_persister1
  typing:
    - master
  to_device:
    - master
  presence:
    - master
  receipts:
    - master

federation_sender_instances:
  - federation_sender1

notify_appservices_from_worker: appservice_sender1

# https://spec.matrix.org/v1.17/rooms/
default_room_version: "12"
encryption_enabled_by_default_for_room_type: invite

database:
  name: psycopg2
  args:
    user: synapse
    password: "${SYNAPSE_DATABASE_PASSWORD}"
    database: synapse
    host: matrix-db-pooler-rw.app-matrix.svc
    port: 5432
    cp_min: 5
    cp_max: 10
    keepalives_idle: 10
    keepalives_interval: 10
    keepalives_count: 3

listeners:
  # Main HTTP for client and federation traffic
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    bind_addresses:
      - 0.0.0.0
    resources:
      - names:
          - client
          - federation
          - metrics
        compress: false

  # Workers talk on this
  - port: 9093
    tls: false
    type: http
    bind_addresses:
      - 0.0.0.0
    resources:
      - names:
        - replication

# Media storage path (used as temporary/cache even with S3)
media_store_path: /data/media_store

media_storage_providers:
  - module: s3_storage_provider.S3StorageProviderBackend
    store_local: true # Uploads from local users
    store_remote: true # From federation
    store_synchronous: true  # Upload immediately (vs background job)
    config:
      bucket: "${SYNAPSE_S3_BUCKET}"
      endpoint_url: "${SYNAPSE_S3_ENDPOINT_URL}"
      region_name: "${SYNAPSE_S3_REGION}"
      access_key_id: "${SYNAPSE_S3_ACCESS_KEY_ID}"
      secret_access_key: "${SYNAPSE_S3_SECRET_ACCESS_KEY}"
      prefix: "synapse-media/"  # Organize within bucket
      storage_class: "STANDARD"

max_upload_size: 25M
max_image_pixels: 32M
url_preview_enabled: true
url_preview_ip_range_blacklist:
  - '127.0.0.0/8'
  - '10.0.0.0/8'
  - '172.16.0.0/12'
  - '192.168.0.0/16'
  - '100.64.0.0/10'
  - '169.254.0.0/16'
  - 'fe80::/64'

signing_key_path: /data/borooka.ee.signing.key

enable_registration: false
registration_shared_secret: "${SYNAPSE_REGISTRATION_SHARED_SECRET}"

password_config:
  enabled: false

matrix_authentication_service:
  enabled: true
  endpoint: "http://mas.app-matrix.svc.cluster.local:8080/"
  # Must match the secret configured in MAS's matrix.secret_file
  secret: "${SYNAPSE_MAS_SHARED_SECRET}"

macaroon_secret_key: "${SYNAPSE_MACAROON_SECRET_KEY}"
form_secret: "${SYNAPSE_FORM_SECRET}"

trusted_key_servers:
  - server_name: "matrix.org"

federation_domain_blacklist:
  - plsdontputmeon.ignorelist.com

federation_rr_transactions_per_room_per_second: 50

rc_federation:
  window_size: 1000
  sleep_limit: 10
  sleep_delay: 500
  reject_limit: 50
  concurrent: 3

federation_client_minimum_retryinterval: 5m
federation_max_short_retryinterval: 1h
federation_max_long_retryinterval: 6h

caches:
  global_factor: 2.0
  per_cache_factors:
    get_users_in_room: 5.0
    get_state_events: 5.0
    get_room_state: 2.0

enable_metrics: true
report_stats: false

turn_uris:
  - "turn:eu.relay.metered.ca:80"
  - "turn:eu.relay.metered.ca:80?transport=tcp"
  - "turns:eu.relay.metered.ca:443?transport=tcp"
turn_username: "${SYNAPSE_TURN_USERNAME}"
turn_password: "${SYNAPSE_TURN_PASSWORD}"
turn_allow_guests: true

log_config: "/config/log.config"

app_service_config_files:
  - /config/hookshot-registration.yml
  - /config/meowlnir-registration.yml
  - /config/discord-registration.yaml
  - /config/meetings-registration.yaml

modules:
  - module: synapse_http_antispam.HTTPAntispam
    config:
      base_url: http://meowlnir.app-matrix.svc:29339/_meowlnir/antispam/!IVNcQHAxUUwAFjlpvf:borooka.ee
      authorization: ${MEOWLNIR_ANTISPAM_TOKEN}
      enabled_callbacks:
        - user_may_invite
        - user_may_join_room
      fail_open:
        user_may_invite: true
        user_may_join_room: true

experimental_features:
  msc3202_device_masquerading: true
  msc3202_transaction_extensions: true
  msc2409_to_device_messages_enabled: true
  msc2815_enabled: true # Appservice encryption support

  # Element Call support
  msc4140_enabled: true  # Delayed events for proper call signalling
  msc3266_enabled: true  # Room summaries

server_notices:
  system_mxid_localpart: notices
  system_mxid_display_name: "System Announcements"
  room_name: "Announcements"
  room_topic: "Updates from instance admins"
  auto_join: true

# Default power levels for public_chat preset (moderation controls)
default_power_level_content_override:
  public_chat:
    invite: 50
    redact: 50
    kick: 50
    ban: 50

# Required for matrix-meetings to find users
user_directory:
  search_all_users: true

delete_stale_devices_after: 1y

room_prejoin_state:
  disable_default_event_types: false
  additional_event_types:
    - m.space.parent
    - net.nordeck.meetings.metadata
    - m.room.power_levels
    - m.room.history_visibility
