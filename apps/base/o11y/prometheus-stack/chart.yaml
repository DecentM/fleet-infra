apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: prometheus-stack
  namespace: app-o11y
spec:
  interval: 10m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: "66.1.1"
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: app-o11y
      interval: 10m

  valuesFrom:
    - kind: Secret
      name: grafana-secrets
      valuesKey: admin-password
      targetPath: grafana.adminPassword

  values:
    ## Using default values from https://github.com/grafana/helm-charts/blob/main/charts/grafana/values.yaml
    ##
    grafana:
      ## Configure additional grafana datasources (passed through tpl)
      ## ref: http://docs.grafana.org/administration/provisioning/#datasources
      additionalDataSources: []
      # - name: prometheus-sample
      #   access: proxy
      #   basicAuth: true
      #   secureJsonData:
      #       basicAuthPassword: pass
      #   basicAuthUser: daco
      #   editable: false
      #   jsonData:
      #       tlsSkipVerify: true
      #   orgId: 1
      #   type: prometheus
      #   url: https://{{ printf "%s-prometheus.svc" .Release.Name }}:9090
      #   version: 1

      # Flag to mark provisioned data sources for deletion if they are no longer configured.
      # It takes no effect if data sources are already listed in the deleteDatasources section.
      # ref: https://grafana.com/docs/grafana/latest/administration/provisioning/#example-data-source-config-file
      prune: true

    ## Setting to true produces cleaner resource names, but requires a data migration because the name of the persistent volume changes. Therefore this should only be set once on initial installation.
    ##
    cleanPrometheusOperatorObjectNames: true
