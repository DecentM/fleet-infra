apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: authelia
  namespace: app-authelia
spec:
  interval: 24h
  url: https://charts.authelia.com
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authelia
  namespace: app-authelia
spec:
  interval: 15m
  chart:
    spec:
      chart: authelia
      version: "0.10.49"
      sourceRef:
        kind: HelmRepository
        name: authelia
        namespace: app-authelia
      interval: 24h

  valuesFrom:
    - kind: Secret
      name: authelia-smtp-secrets
      valuesKey: SMTP_ADDRESS
      targetPath: configMap.notifier.smtp.address
    - kind: Secret
      name: authelia-smtp-secrets
      valuesKey: SMTP_USERNAME
      targetPath: configMap.notifier.smtp.username
    - kind: Secret
      name: authelia-smtp-secrets
      valuesKey: SMTP_SENDER
      targetPath: configMap.notifier.smtp.sender

  values:
    pod:
      kind: Deployment
      replicas: 1
      selectors:
        nodeSelector:
          kubernetes.io/hostname: cadance
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
      env:
        - name: X_AUTHELIA_CONFIG_FILTERS
          value: "template"
      extraVolumes:
        - name: oidc-clients
          configMap:
            name: authelia-oidc-clients
            namespace: app-authelia
      extraVolumeMounts:
        - name: oidc-clients
          mountPath: /config.d
          readOnly: true

    service:
      type: ClusterIP
      port: 9091

    # We got our own Traefik one
    ingress:
      enabled: false

    secret:
      existingSecret: authelia-secrets
      mountPath: /secrets
      additionalSecrets:
        authelia-db-app: {}
        authelia-secrets: {}  # /secrets/authelia-secrets/
        authelia-smtp-secrets: {}  # /secrets/authelia-smtp-secrets/
        lldap-authelia-bind: {}  # /secrets/lldap-authelia-bind/
        authelia-client-jellyfin: {}  # /secrets/authelia-client-jellyfin/
        authelia-client-mas: {}  # /secrets/authelia-client-mas/

    configMap:
      theme: dark

      extraConfigs:
        - /config.d/clients.yaml

      server:
        endpoints:
          authz:
            forward-auth:
              implementation: ForwardAuth

      log:
        level: info
        format: text

      totp:
        disable: false
        issuer: authelia.cluster.arpa

      webauthn:
        disable: false
        display_name: Authelia
        enable_passkey_login: true
        attestation_conveyance_preference: "direct"

        selection_criteria:
          discoverability: "preferred"  # Available but not required

        filtering:
          prohibit_backup_eligibility: false

        metadata:
          enabled: true
          validate_trust_anchor: true
          validate_entry: true
          validate_status: true
          validate_entry_permit_zero_aaguid: false

      identity_validation:
        reset_password:
          secret:
            disabled: false
            secret_name: ~  # null = use internal secret (existingSecret)
            path: JWT_SECRET

      authentication_backend:
        password_reset:
          disable: false
        ldap:
          enabled: true
          implementation: lldap
          address: ldap://lldap.app-authelia.svc.cluster.local:3890
          timeout: 5s
          start_tls: false
          base_dn: dc=cluster,dc=arpa
          additional_users_dn: ou=people
          users_filter: "(&(|({username_attribute}={input})({mail_attribute}={input}))(objectClass=person))"
          additional_groups_dn: ou=groups
          groups_filter: "(member={dn})"
          user: uid=authelia,ou=people,dc=cluster,dc=arpa
          attributes:
            username: uid
            display_name: displayName
            mail: mail
            group_name: cn

          password:
            disabled: false
            secret_name: lldap-authelia-bind
            path: password

      access_control:
        default_policy: deny
        rules:
          - domain:
              - auth.cluster.arpa
              - auth.decentm.com
              - auth.borooka.ee
            policy: bypass
          - domain:
              - matrix.borooka.ee
              - element.borooka.ee
              - element-call.borooka.ee
            subject: "group:matrix-users"
            policy: two_factor
          - domain:
              - matrix.borooka.ee
              - element.borooka.ee
              - element-call.borooka.ee
            policy: deny
          - domain:
              - "*.cluster.arpa"
              - "*.decentm.com"
              - "*.borooka.ee"
            policy: two_factor

      session:
        name: authelia_session
        same_site: lax
        inactivity: 5m
        expiration: 1h
        remember_me: 1M
        cookies:
          - domain: cluster.arpa
            authelia_url: https://auth.cluster.arpa
            default_redirection_url: https://auth.cluster.arpa
          - domain: decentm.com
            authelia_url: https://auth.decentm.com
            default_redirection_url: https://auth.decentm.com
          - domain: borooka.ee
            authelia_url: https://auth.borooka.ee
            default_redirection_url: https://auth.borooka.ee
        encryption_key:
          disabled: false
          secret_name: ~  # null = use internal secret
          path: SESSION_SECRET

      regulation:
        max_retries: 3
        find_time: 2m
        ban_time: 5m

      storage:
        postgres:
          enabled: true
          address: tcp://authelia-db-rw.app-authelia.svc.cluster.local:5432
          database: authelia
          username: authelia
          timeout: 5s
          password:
            disabled: false
            secret_name: authelia-db-app
            path: password
        encryption_key:
          disabled: false
          secret_name: ~  # null = use internal secret
          path: STORAGE_ENCRYPTION_KEY

      notifier:
        disable_startup_check: false
        smtp:
          enabled: true
          timeout: 5s
          subject: "[Authelia] {title}"
          startup_check_address: test@authelia.com
          disable_require_tls: false
          disable_starttls: false
          disable_html_emails: false
          password:
            disabled: false
            secret_name: authelia-smtp-secrets
            path: SMTP_PASSWORD

      identity_providers:
        oidc:
          enabled: true
          hmac_secret:
            disabled: false
            secret_name: ~  # null = use internal secret
            path: IDENTITY_PROVIDERS_OIDC_HMAC_SECRET
          jwks:
            - key_id: main
              use: sig
              algorithm: RS256
              key:
                path: /secrets/authelia-secrets/IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY
