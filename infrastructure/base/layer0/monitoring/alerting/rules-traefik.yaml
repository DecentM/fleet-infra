apiVersion: 1
groups:
  - orgId: 1
    name: traefik
    folder: Infrastructure
    interval: 1m
    rules:
      - uid: traefik-high-error-rate
        title: Traefik High Error Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(traefik_service_requests_total{code=~"5.."}[5m])) / sum(rate(traefik_service_requests_total[5m])) * 100 > 5
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
              refId: C
              type: classic_conditions
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Traefik high error rate"
          description: "Traefik is experiencing more than 5% 5xx error rate."

      - uid: traefik-service-high-error-rate
        title: Traefik Service High Error Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum by(service) (rate(traefik_service_requests_total{code=~"5.."}[5m])) / sum by(service) (rate(traefik_service_requests_total[5m])) * 100 > 10
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
              refId: C
              type: classic_conditions
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate on service {{ index $labels \"service\" }}"
          description: "Service is returning more than 10% 5xx errors."

      - uid: traefik-high-latency
        title: Traefik High Latency
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: histogram_quantile(0.95, sum(rate(traefik_service_request_duration_seconds_bucket[5m])) by (le)) > 2
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
              refId: C
              type: classic_conditions
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Traefik high latency"
          description: "Traefik P95 latency is above 2 seconds."

      - uid: traefik-down
        title: Traefik Down
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: up{job=~".*traefik.*"} == 0
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
              refId: C
              type: classic_conditions
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Traefik is down"
          description: "Traefik instance {{ index $labels \"instance\" }} is down."

      - uid: traefik-cert-expiring-soon
        title: TLS Certificate Expiring Soon
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 3600
              to: 0
            datasourceUid: prometheus
            model:
              expr: (max by (cn, sans) (traefik_tls_certs_not_after) - time()) / 86400 < 7
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 3600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
              refId: C
              type: classic_conditions
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "TLS certificate expiring soon"
          description: "Certificate for {{ index $labels \"cn\" }} expires in less than 7 days. Auto-renewal may have failed."

      - uid: traefik-cert-expiring-critical
        title: TLS Certificate Expiring Critical
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 3600
              to: 0
            datasourceUid: prometheus
            model:
              expr: (max by (cn, sans) (traefik_tls_certs_not_after) - time()) / 86400 < 3
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 3600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
              refId: C
              type: classic_conditions
        for: 30m
        labels:
          severity: critical
        annotations:
          summary: "TLS certificate expiring critically soon"
          description: "Certificate for {{ index $labels \"cn\" }} expires in less than 3 days. Immediate action required."

      - uid: traefik-cert-expired
        title: TLS Certificate Expired
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: (max by (cn, sans) (traefik_tls_certs_not_after) - time()) < 0
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
              refId: C
              type: classic_conditions
        for: 0s
        labels:
          severity: critical
        annotations:
          summary: "TLS certificate expired"
          description: "Certificate for {{ index $labels \"cn\" }} has expired."
