apiVersion: 1
groups:
  - orgId: 1
    name: kubernetes-pods
    folder: Infrastructure
    interval: 1m
    rules:
      - uid: pod-crash-looping
        title: Pod Crash Looping
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: prometheus
            model:
              expr: rate(kube_pod_container_status_restarts_total[15m]) * 60 * 15 > 3
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
              refId: C
              type: classic_conditions
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Pod {{ index $labels \"namespace\" }}/{{ index $labels \"pod\" }} is crash looping"
          description: "Pod has restarted more than 3 times in the last 15 minutes."

      - uid: pod-not-ready
        title: Pod Not Ready
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: kube_pod_status_ready{condition="true"} == 0 and on(pod, namespace) kube_pod_status_phase{phase=~"Running|Pending"} == 1
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
              refId: C
              type: classic_conditions
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Pod {{ index $labels \"namespace\" }}/{{ index $labels \"pod\" }} is not ready"
          description: "Pod has been not ready for more than 10 minutes."

      - uid: container-oom-killed
        title: Container OOM Killed
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: kube_pod_container_status_last_terminated_reason{reason="OOMKilled"} == 1
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
              refId: C
              type: classic_conditions
        for: 0s
        labels:
          severity: warning
        annotations:
          summary: "Container {{ index $labels \"container\" }} OOM killed"
          description: "Container in pod {{ index $labels \"namespace\" }}/{{ index $labels \"pod\" }} was OOM killed."

      - uid: pod-pending
        title: Pod Pending
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: prometheus
            model:
              expr: kube_pod_status_phase{phase="Pending"} == 1
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
              refId: C
              type: classic_conditions
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Pod {{ index $labels \"namespace\" }}/{{ index $labels \"pod\" }} stuck in Pending"
          description: "Pod has been pending for more than 15 minutes."
