apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
  namespace: keycloak-system
  labels:
    app: keycloak
spec:
  replicas: 1
  selector:
    matchLabels:
      app: keycloak
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: keycloak
    spec:
      initContainers:
        # Process realm JSON with envsubst to inject client secrets
        - name: realm-processor
          image: alpine:3.21
          command:
            - /bin/sh
            - -c
            - |
              apk add --no-cache gettext
              envsubst < /realm-template/cluster-realm.json > /realm-processed/cluster-realm.json
          env:
            - name: OAUTH2_PROXY_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-client-secrets
                  key: OAUTH2_PROXY_CLIENT_SECRET
            - name: GRAFANA_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-client-secrets
                  key: GRAFANA_CLIENT_SECRET
            - name: JELLYFIN_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-client-secrets
                  key: JELLYFIN_CLIENT_SECRET
            - name: PAPERLESS_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-client-secrets
                  key: PAPERLESS_CLIENT_SECRET
            - name: PHOTOPRISM_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-client-secrets
                  key: PHOTOPRISM_CLIENT_SECRET
            - name: HOME_ASSISTANT_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: keycloak-client-secrets
                  key: HOME_ASSISTANT_CLIENT_SECRET
          volumeMounts:
            - name: realm-template
              mountPath: /realm-template
              readOnly: true
            - name: realm-processed
              mountPath: /realm-processed
      containers:
        - name: keycloak
          image: quay.io/keycloak/keycloak:26.2.4
          args:
            - start
            - --import-realm
          env:
            - name: KC_HOSTNAME
              value: "keycloak.cluster.arpa"
            - name: KC_HOSTNAME_STRICT
              value: "false"
            - name: KC_PROXY_HEADERS
              value: "xforwarded"
            - name: KC_HTTP_ENABLED
              value: "true"
            - name: KC_HEALTH_ENABLED
              value: "true"
            - name: KC_METRICS_ENABLED
              value: "true"
            - name: KC_DB
              value: "postgres"
            - name: KC_DB_URL
              value: "jdbc:postgresql://keycloak-db-rw.keycloak-system.svc.cluster.local:5432/keycloak"
            - name: KC_DB_USERNAME
              valueFrom:
                secretKeyRef:
                  name: keycloak-db-app
                  key: username
            - name: KC_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-db-app
                  key: password
            - name: KEYCLOAK_ADMIN
              valueFrom:
                secretKeyRef:
                  name: keycloak-admin
                  key: username
            - name: KEYCLOAK_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-admin
                  key: password
          ports:
            - name: http
              containerPort: 8080
            - name: https
              containerPort: 8443
            - name: metrics
              containerPort: 9000
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 9000
            initialDelaySeconds: 30
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health/live
              port: 9000
            initialDelaySeconds: 60
            periodSeconds: 30
          volumeMounts:
            - name: realm-processed
              mountPath: /opt/keycloak/data/import
              readOnly: true
      volumes:
        - name: realm-template
          configMap:
            name: keycloak-realm
        - name: realm-processed
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: keycloak
  namespace: keycloak-system
  labels:
    app: keycloak
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: http
    - name: https
      port: 443
      targetPort: https
  selector:
    app: keycloak
---
apiVersion: v1
kind: Service
metadata:
  name: keycloak-metrics
  namespace: keycloak-system
  labels:
    app: keycloak
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9000"
spec:
  ports:
    - name: metrics
      port: 9000
      targetPort: metrics
  selector:
    app: keycloak
